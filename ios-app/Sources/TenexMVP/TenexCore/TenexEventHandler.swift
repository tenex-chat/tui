import Foundation

// MARK: - Notification Names

extension Notification.Name {
    /// Posted when messages change for a conversation.
    /// Object: conversation ID (String)
    static let tenexMessagesChanged = Notification.Name("tenexMessagesChanged")

    /// Posted when a streaming text chunk arrives.
    /// UserInfo keys: "agentPubkey", "conversationId", "textDelta" (optional)
    static let tenexStreamChunk = Notification.Name("tenexStreamChunk")

    /// Posted when project status changes (kind:24010).
    static let tenexProjectStatusChanged = Notification.Name("tenexProjectStatusChanged")

    /// Posted when any data changes and a general refresh is recommended.
    static let tenexDataChanged = Notification.Name("tenexDataChanged")
}

// MARK: - Event Handler

/// Handles event callbacks from Rust core and dispatches to UI via NotificationCenter.
/// Implements the EventCallback protocol generated by UniFFI.
///
/// Thread Safety: Callbacks are invoked from a background thread in Rust.
/// This handler dispatches all notifications to the main thread for safe UI updates.
final class TenexEventHandler: EventCallback {
    weak var coreManager: TenexCoreManager?

    init(coreManager: TenexCoreManager) {
        self.coreManager = coreManager
    }

    /// Called by Rust when data has changed.
    /// Dispatches to main thread and posts appropriate notifications.
    func onDataChanged(changeType: DataChangeType) {
        DispatchQueue.main.async { [weak self] in
            guard let coreManager = self?.coreManager else { return }

            switch changeType {
            case .messages(let conversationId):
                // Post notification for conversation-specific refresh
                NotificationCenter.default.post(
                    name: .tenexMessagesChanged,
                    object: conversationId
                )
                // Also trigger general refresh for inbox/conversation list updates
                coreManager.objectWillChange.send()

            case .projectStatus:
                // Post project status notification
                NotificationCenter.default.post(
                    name: .tenexProjectStatusChanged,
                    object: nil
                )
                // Trigger general refresh for online agents, etc.
                coreManager.objectWillChange.send()

            case .streamChunk(let agentPubkey, let conversationId, let textDelta):
                // Post streaming notification with details
                NotificationCenter.default.post(
                    name: .tenexStreamChunk,
                    object: nil,
                    userInfo: [
                        "agentPubkey": agentPubkey,
                        "conversationId": conversationId,
                        "textDelta": textDelta as Any
                    ]
                )

            case .general:
                // Post general data changed notification
                NotificationCenter.default.post(
                    name: .tenexDataChanged,
                    object: nil
                )
                // Trigger full refresh
                coreManager.objectWillChange.send()
            }
        }
    }
}
